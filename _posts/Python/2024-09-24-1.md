---
layout: single
title:  "Python MLOps"
categories: Python
tag: [Fastcampus, Python]
toc: true
author_profile: false
---

<head>
  <style>
    table.dataframe {
      white-space: normal;
      width: 100%;
      height: 240px;
      display: block;
      overflow: auto;
      font-family: Arial, sans-serif;
      font-size: 0.9rem;
      line-height: 20px;
      text-align: center;
      border: 0px !important;
    }

    table.dataframe th {
      text-align: center;
      font-weight: bold;
      padding: 8px;
    }

    table.dataframe td {
      text-align: center;
      padding: 8px;
    }

    table.dataframe tr:hover {
      background: #b8d1f3; 
    }

    .output_prompt {
      overflow: auto;
      font-size: 0.9rem;
      line-height: 1.45;
      border-radius: 0.3rem;
      -webkit-overflow-scrolling: touch;
      padding: 0.8rem;
      margin-top: 0;
      margin-bottom: 15px;
      font: 1rem Consolas, "Liberation Mono", Menlo, Courier, monospace;
      color: $code-text-color;
      border: solid 1px $border-color;
      border-radius: 0.3rem;
      word-break: normal;
      white-space: pre;
    }

  .dataframe tbody tr th:only-of-type {
      vertical-align: middle;
  }

  .dataframe tbody tr th {
      vertical-align: top;
  }

  .dataframe thead th {
      text-align: center !important;
      padding: 8px;
  }

  .page__content p {
      margin: 0 0 0px !important;
  }

  .page__content p > strong {
    font-size: 0.8rem !important;
  }

  </style>
</head>


MLFlow



```python
import mlflow
import mlflow.sklearn
import pandas as pd
from sklearn.model_selection import train_test_split
from sklearn.datasets import load_iris
from sklearn.linear_model import LogisticRegression
from sklearn.metrics import accuracy_score
from sklearn.preprocessing import StandardScaler
from sklearn.ensemble import RandomForestClassifier
from sklearn.svm import SVC
```


```python
mlflow.__version__
```

<pre>
'2.16.2'
</pre>

```python
iris = load_iris()

iris.data          # feature data
iris.target        # label data
iris.feature_names # col name
```

<pre>
['sepal length (cm)',
 'sepal width (cm)',
 'petal length (cm)',
 'petal width (cm)']
</pre>

```python
df = pd.DataFrame(iris.data, columns=iris.feature_names)
```


```python
df['Label'] = iris.target
df
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sepal length (cm)</th>
      <th>sepal width (cm)</th>
      <th>petal length (cm)</th>
      <th>petal width (cm)</th>
      <th>Label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>5.1</td>
      <td>3.5</td>
      <td>1.4</td>
      <td>0.2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>4.9</td>
      <td>3.0</td>
      <td>1.4</td>
      <td>0.2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4.7</td>
      <td>3.2</td>
      <td>1.3</td>
      <td>0.2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4.6</td>
      <td>3.1</td>
      <td>1.5</td>
      <td>0.2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5.0</td>
      <td>3.6</td>
      <td>1.4</td>
      <td>0.2</td>
      <td>0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>145</th>
      <td>6.7</td>
      <td>3.0</td>
      <td>5.2</td>
      <td>2.3</td>
      <td>2</td>
    </tr>
    <tr>
      <th>146</th>
      <td>6.3</td>
      <td>2.5</td>
      <td>5.0</td>
      <td>1.9</td>
      <td>2</td>
    </tr>
    <tr>
      <th>147</th>
      <td>6.5</td>
      <td>3.0</td>
      <td>5.2</td>
      <td>2.0</td>
      <td>2</td>
    </tr>
    <tr>
      <th>148</th>
      <td>6.2</td>
      <td>3.4</td>
      <td>5.4</td>
      <td>2.3</td>
      <td>2</td>
    </tr>
    <tr>
      <th>149</th>
      <td>5.9</td>
      <td>3.0</td>
      <td>5.1</td>
      <td>1.8</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
<p>150 rows × 5 columns</p>
</div>



```python
X_train, X_test, y_train, y_test = train_test_split(iris.data, iris.target, test_size=.2, random_state=123)
```


```python
model = LogisticRegression(max_iter = 0)

model.fit(X_train, y_train) # 모의고사 : X_train, y_train
```

<pre>
/data/ephemeral/home/.venv/lib/python3.10/site-packages/sklearn/linear_model/_logistic.py:469: ConvergenceWarning: lbfgs failed to converge (status=1):
STOP: TOTAL NO. of ITERATIONS REACHED LIMIT.

Increase the number of iterations (max_iter) or scale the data as shown in:
    https://scikit-learn.org/stable/modules/preprocessing.html
Please also refer to the documentation for alternative solver options:
    https://scikit-learn.org/stable/modules/linear_model.html#logistic-regression
  n_iter_i = _check_optimize_result(
</pre>
<style>#sk-container-id-5 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: black;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-5 {
  color: var(--sklearn-color-text);
}

#sk-container-id-5 pre {
  padding: 0;
}

#sk-container-id-5 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-5 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-5 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-5 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-5 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-5 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-5 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-5 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-5 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-5 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-5 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-5 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-5 label.sk-toggleable__label {
  cursor: pointer;
  display: block;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
}

#sk-container-id-5 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-5 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-5 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-5 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-5 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-5 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-5 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-5 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-5 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-5 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-5 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-5 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-5 div.sk-label label.sk-toggleable__label,
#sk-container-id-5 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-5 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-5 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-5 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-5 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-5 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-5 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-5 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-5 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 1ex;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-5 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-5 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-5 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-5 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style><div id="sk-container-id-5" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>LogisticRegression(max_iter=0)</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-5" type="checkbox" checked><label for="sk-estimator-id-5" class="sk-toggleable__label fitted sk-toggleable__label-arrow fitted">&nbsp;&nbsp;LogisticRegression<a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.5/modules/generated/sklearn.linear_model.LogisticRegression.html">?<span>Documentation for LogisticRegression</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></label><div class="sk-toggleable__content fitted"><pre>LogisticRegression(max_iter=0)</pre></div> </div></div></div></div>



```python
pred = model.predict(X_test)
```


```python
accuracy_score(y_test, pred)
```

<pre>
0.36666666666666664
</pre>

```python
df.describe()

# 값의 표준편차가 크다는 것을 확인했다. -> Sacler를 사용해서 값의 편차를 줄여줌
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sepal length (cm)</th>
      <th>sepal width (cm)</th>
      <th>petal length (cm)</th>
      <th>petal width (cm)</th>
      <th>Label</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>150.000000</td>
      <td>150.000000</td>
      <td>150.000000</td>
      <td>150.000000</td>
      <td>150.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>5.843333</td>
      <td>3.057333</td>
      <td>3.758000</td>
      <td>1.199333</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>std</th>
      <td>0.828066</td>
      <td>0.435866</td>
      <td>1.765298</td>
      <td>0.762238</td>
      <td>0.819232</td>
    </tr>
    <tr>
      <th>min</th>
      <td>4.300000</td>
      <td>2.000000</td>
      <td>1.000000</td>
      <td>0.100000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>5.100000</td>
      <td>2.800000</td>
      <td>1.600000</td>
      <td>0.300000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>5.800000</td>
      <td>3.000000</td>
      <td>4.350000</td>
      <td>1.300000</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>6.400000</td>
      <td>3.300000</td>
      <td>5.100000</td>
      <td>1.800000</td>
      <td>2.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>7.900000</td>
      <td>4.400000</td>
      <td>6.900000</td>
      <td>2.500000</td>
      <td>2.000000</td>
    </tr>
  </tbody>
</table>
</div>



```python
scaler = StandardScaler()

X_scaled = scaler.fit_transform(iris.data)

X_train, X_test, y_train, y_test = train_test_split(X_scaled, iris.target, test_size=.2, random_state=123)

model = LogisticRegression(max_iter=0)

model.fit(X_train, y_train)
pred = model.predict(X_test)

accuracy_score(y_test, pred)
```

<pre>
/data/ephemeral/home/.venv/lib/python3.10/site-packages/sklearn/linear_model/_logistic.py:469: ConvergenceWarning: lbfgs failed to converge (status=1):
STOP: TOTAL NO. of ITERATIONS REACHED LIMIT.

Increase the number of iterations (max_iter) or scale the data as shown in:
    https://scikit-learn.org/stable/modules/preprocessing.html
Please also refer to the documentation for alternative solver options:
    https://scikit-learn.org/stable/modules/linear_model.html#logistic-regression
  n_iter_i = _check_optimize_result(
</pre>
<pre>
0.9333333333333333
</pre>

```python
df = pd.DataFrame(X_scaled, columns=iris.feature_names)
df.describe()
```

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>sepal length (cm)</th>
      <th>sepal width (cm)</th>
      <th>petal length (cm)</th>
      <th>petal width (cm)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>1.500000e+02</td>
      <td>1.500000e+02</td>
      <td>1.500000e+02</td>
      <td>1.500000e+02</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>-1.468455e-15</td>
      <td>-1.823726e-15</td>
      <td>-1.610564e-15</td>
      <td>-9.473903e-16</td>
    </tr>
    <tr>
      <th>std</th>
      <td>1.003350e+00</td>
      <td>1.003350e+00</td>
      <td>1.003350e+00</td>
      <td>1.003350e+00</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-1.870024e+00</td>
      <td>-2.433947e+00</td>
      <td>-1.567576e+00</td>
      <td>-1.447076e+00</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>-9.006812e-01</td>
      <td>-5.923730e-01</td>
      <td>-1.226552e+00</td>
      <td>-1.183812e+00</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>-5.250608e-02</td>
      <td>-1.319795e-01</td>
      <td>3.364776e-01</td>
      <td>1.325097e-01</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>6.745011e-01</td>
      <td>5.586108e-01</td>
      <td>7.627583e-01</td>
      <td>7.906707e-01</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2.492019e+00</td>
      <td>3.090775e+00</td>
      <td>1.785832e+00</td>
      <td>1.712096e+00</td>
    </tr>
  </tbody>
</table>
</div>



```python
mlflow.set_tracking_uri('http://127.0.0.1:5000') # ex) dev.upstage.com:5000
print(mlflow.get_tracking_uri())
```

<pre>
http://127.0.0.1:5000
</pre>

```python
exp = mlflow.set_experiment(experiment_name='iris_classfication')

exp.name
exp.experiment_id
exp.artifact_location
exp.creation_time
```

<pre>
1726803122702
</pre>

```python
import time
time.localtime(1726803122702)

from datetime import datetime
datetime.fromtimestamp(1726803122702 / 1000)  # 밀리초 -> 초
```

<pre>
datetime.datetime(2024, 9, 20, 3, 32, 2, 702000)
</pre>

```python
mlflow.autolog()

mlflow.start_run()  # start_run 이후 모델을 불러오고 , 실험하는 코드들을 작성

model = LogisticRegression(max_iter= 0 )
model.fit(X_train, y_train)
pred = model.predict(X_test)
accuracy = accuracy_score(y_test, pred)
print(f'정확도 : {accuracy * 100}')

mlflow.end_run()
```

<pre>
2024/09/20 03:41:03 WARNING mlflow.utils.autologging_utils: MLflow sklearn autologging is known to be compatible with 0.24.1 <= scikit-learn <= 1.5.1, but the installed version is 1.5.2. If you encounter errors during autologging, try upgrading / downgrading scikit-learn to a compatible version, or try upgrading MLflow.
2024/09/20 03:41:04 INFO mlflow.tracking.fluent: Autologging successfully enabled for sklearn.
2024/09/20 03:41:04 WARNING mlflow.utils.git_utils: Failed to import Git (the Git executable is probably not on your PATH), so Git SHA is not available. Error: Failed to initialize: Bad git executable.
The git executable must be specified in one of the following ways:
    - be included in your $PATH
    - be set via $GIT_PYTHON_GIT_EXECUTABLE
    - explicitly set via git.refresh(<full-path-to-git-executable>)

All git commands will error until this is rectified.

This initial message can be silenced or aggravated in the future by setting the
$GIT_PYTHON_REFRESH environment variable. Use one of the following values:
    - quiet|q|silence|s|silent|none|n|0: for no message or exception
    - warn|w|warning|log|l|1: for a warning message (logging level CRITICAL, displayed by default)
    - error|e|exception|raise|r|2: for a raised exception

Example:
    export GIT_PYTHON_REFRESH=quiet

/data/ephemeral/home/.venv/lib/python3.10/site-packages/sklearn/linear_model/_logistic.py:469: ConvergenceWarning: lbfgs failed to converge (status=1):
STOP: TOTAL NO. of ITERATIONS REACHED LIMIT.

Increase the number of iterations (max_iter) or scale the data as shown in:
    https://scikit-learn.org/stable/modules/preprocessing.html
Please also refer to the documentation for alternative solver options:
    https://scikit-learn.org/stable/modules/linear_model.html#logistic-regression
  n_iter_i = _check_optimize_result(
2024/09/20 03:41:06 INFO mlflow.tracking._tracking_service.client: 🏃 View run learned-dove-431 at: http://127.0.0.1:5000/#/experiments/331369378510877407/runs/cec386493dca4f67ab3fdb57f4f73b2e.
2024/09/20 03:41:06 INFO mlflow.tracking._tracking_service.client: 🧪 View experiment at: http://127.0.0.1:5000/#/experiments/331369378510877407.
</pre>
<pre>
정확도 : 93.33333333333333
</pre>

```python
mlflow.autolog()

with mlflow.start_run():
    model = LogisticRegression(max_iter= 0 )
    model.fit(X_train, y_train)
    pred = model.predict(X_test)
    accuracy = accuracy_score(y_test, pred)
    print(f'정확도 : {accuracy * 100}')
```

<pre>
2024/09/20 05:04:50 WARNING mlflow.utils.autologging_utils: MLflow sklearn autologging is known to be compatible with 0.24.1 <= scikit-learn <= 1.5.1, but the installed version is 1.5.2. If you encounter errors during autologging, try upgrading / downgrading scikit-learn to a compatible version, or try upgrading MLflow.
2024/09/20 05:04:50 INFO mlflow.tracking.fluent: Autologging successfully enabled for sklearn.
/data/ephemeral/home/.venv/lib/python3.10/site-packages/sklearn/linear_model/_logistic.py:469: ConvergenceWarning: lbfgs failed to converge (status=1):
STOP: TOTAL NO. of ITERATIONS REACHED LIMIT.

Increase the number of iterations (max_iter) or scale the data as shown in:
    https://scikit-learn.org/stable/modules/preprocessing.html
Please also refer to the documentation for alternative solver options:
    https://scikit-learn.org/stable/modules/linear_model.html#logistic-regression
  n_iter_i = _check_optimize_result(
2024/09/20 05:04:52 INFO mlflow.tracking._tracking_service.client: 🏃 View run abrasive-crane-579 at: http://127.0.0.1:5000/#/experiments/331369378510877407/runs/8c4d1a404dc348599a31e465aa515485.
2024/09/20 05:04:52 INFO mlflow.tracking._tracking_service.client: 🧪 View experiment at: http://127.0.0.1:5000/#/experiments/331369378510877407.
</pre>
<pre>
정확도 : 93.33333333333333
</pre>

```python
# 알고리즘별 성능 테스트

models = {
    "LogisticRegression":LogisticRegression(max_iter=0, C = 1.0, solver='lbfgs', random_state=123),
    "RandomForestClassifier":RandomForestClassifier(n_estimators=100, random_state=123),
    "SVC":SVC(kernel='linear', random_state=123)
}
```


```python
for model_name, model in models.items():
    model.fit(X_train, y_train)
    pred = model.predict(X_test)
    acc = accuracy_score(y_test, pred)

    mlflow.log_param('log_param_key', 'log_param_value')
    mlflow.log_metric('log_metric_key', 0.01)

    print(f'모델명 : {model_name}, 정확도 : {acc * 100}')
```

<pre>
/data/ephemeral/home/.venv/lib/python3.10/site-packages/sklearn/linear_model/_logistic.py:469: ConvergenceWarning: lbfgs failed to converge (status=1):
STOP: TOTAL NO. of ITERATIONS REACHED LIMIT.

Increase the number of iterations (max_iter) or scale the data as shown in:
    https://scikit-learn.org/stable/modules/preprocessing.html
Please also refer to the documentation for alternative solver options:
    https://scikit-learn.org/stable/modules/linear_model.html#logistic-regression
  n_iter_i = _check_optimize_result(
</pre>
<pre>
모델명 : LogisticRegression, 정확도 : 93.33333333333333
모델명 : RandomForestClassifier, 정확도 : 93.33333333333333
</pre>
<pre>
2024/09/20 05:18:24 WARNING mlflow.utils.autologging_utils: Encountered unexpected error during sklearn autologging: The following failures occurred while performing one or more logging operations: [MlflowException('Failed to perform one or more operations on the run with ID 0cc9d6a81c6749638403215e22971289. Failed operations: [MlflowException("API request to http://127.0.0.1:5000/api/2.0/mlflow/runs/log-batch failed with exception HTTPConnectionPool(host=\'127.0.0.1\', port=5000): Max retries exceeded with url: /api/2.0/mlflow/runs/log-batch (Caused by ResponseError(\'too many 500 error responses\'))")]')]
</pre>
<pre>
모델명 : SVC, 정확도 : 93.33333333333333
</pre>

```python
best_acc = 0

today = datetime.today().strftime('%Y-%m-%d %H:%M:%s')
mlflow.autolog()

for model_name, model in models.items():
    with mlflow.start_run(run_name=f'{today} - {model_name}', nested=True):
        model.fit(X_train, y_train)
        pred = model.predict(X_test)
        acc = accuracy_score(y_test, pred)

    if acc > best_acc:
        print()

    mlflow.log_param('log_param_key', 'log_param_value')
    mlflow.log_metric('log_metric_key', 0.01)

    print(f'모델명 : {model_name}, 정확도 : {acc * 100}')
```

<pre>
2024/09/20 05:24:23 WARNING mlflow.utils.autologging_utils: MLflow sklearn autologging is known to be compatible with 0.24.1 <= scikit-learn <= 1.5.1, but the installed version is 1.5.2. If you encounter errors during autologging, try upgrading / downgrading scikit-learn to a compatible version, or try upgrading MLflow.
2024/09/20 05:24:23 INFO mlflow.tracking.fluent: Autologging successfully enabled for sklearn.
/data/ephemeral/home/.venv/lib/python3.10/site-packages/sklearn/linear_model/_logistic.py:469: ConvergenceWarning: lbfgs failed to converge (status=1):
STOP: TOTAL NO. of ITERATIONS REACHED LIMIT.

Increase the number of iterations (max_iter) or scale the data as shown in:
    https://scikit-learn.org/stable/modules/preprocessing.html
Please also refer to the documentation for alternative solver options:
    https://scikit-learn.org/stable/modules/linear_model.html#logistic-regression
  n_iter_i = _check_optimize_result(
2024/09/20 05:24:25 INFO mlflow.tracking._tracking_service.client: 🏃 View run 2024-09-20 05:24:1726809863 - LogisticRegression at: http://127.0.0.1:5000/#/experiments/331369378510877407/runs/f8f19c0a079d48b09627e6c888843c65.
2024/09/20 05:24:25 INFO mlflow.tracking._tracking_service.client: 🧪 View experiment at: http://127.0.0.1:5000/#/experiments/331369378510877407.
</pre>
<pre>

모델명 : LogisticRegression, 정확도 : 93.33333333333333
</pre>
<pre>
2024/09/20 05:24:26 INFO mlflow.tracking._tracking_service.client: 🏃 View run 2024-09-20 05:24:1726809863 - RandomForestClassifier at: http://127.0.0.1:5000/#/experiments/331369378510877407/runs/347572c94a9b4ea585116e712c5d9445.
2024/09/20 05:24:26 INFO mlflow.tracking._tracking_service.client: 🧪 View experiment at: http://127.0.0.1:5000/#/experiments/331369378510877407.
</pre>
<pre>

모델명 : RandomForestClassifier, 정확도 : 93.33333333333333
</pre>
<pre>
2024/09/20 05:24:28 INFO mlflow.tracking._tracking_service.client: 🏃 View run 2024-09-20 05:24:1726809863 - SVC at: http://127.0.0.1:5000/#/experiments/331369378510877407/runs/8026e86569ba4831974f69f8ae6f46f9.
2024/09/20 05:24:28 INFO mlflow.tracking._tracking_service.client: 🧪 View experiment at: http://127.0.0.1:5000/#/experiments/331369378510877407.
</pre>
<pre>

모델명 : SVC, 정확도 : 93.33333333333333
</pre>
MLFlow 모델 관리

- Stage 관리를 하겠다라는 뜻



4개의 함수

1. model_register()

2. promote_to_staging() : 모델 등록 & Staging 단계로 승격

3. promote_to_production() : Production 단계로 승격

4. archive_model() : 모델 아카이빙



```python
from mlflow.tracking import MlflowClient

client = MlflowClient()

def model_register(model_name, run_id):
    model_uri = f'runs:/{run_id}/model'
    model_version = mlflow.register_model(model_uri, model_name)

    return model_version # workflow management

def promote_to_staging(model_name, run_id):
    model_version = model_register(model_name, run_id)

    client.set_model_version_tag(name = model_name, version = model_version.version, key = 'stage', value = 'staging')
    print(f'Model : {model_name}, Version : {model_version} promoted to Staging...')

def promote_to_production(model_name, version):
    client.set_model_version_tag(name= model_name, version= version, key= 'stage', value='production')
    print(f'Model : {model_name}, Version :{version} promoted to Production...')

def archive_model(model_name, version):
    client.set_model_version_tag(name=model_name, version=version, key='stage', value='archived')
    print(f'Model : {model_name}, Version :{version} Archived...')
```


```python
# 하이퍼파라미터 튜닝 추가
import mlflow
import mlflow.sklearn
from datetime import datetime
from sklearn.metrics import accuracy_score
from sklearn.model_selection import GridSearchCV
from sklearn.linear_model import LogisticRegression
from sklearn.ensemble import RandomForestClassifier
from sklearn.svm import SVC
import pandas as pd

# 모델 및 하이퍼파라미터 설정
models = {
    "LogisticRegression": LogisticRegression(max_iter=1000, C=1.0, solver='lbfgs', random_state=123),
    "RandomForestClassifier": RandomForestClassifier(random_state=123),
    "SVC": SVC(random_state=123)
}

# 하이퍼파라미터 그리드 설정
param_grids = {
    "LogisticRegression": {
        'C': [0.1, 1.0, 10.0],
        'solver': ['lbfgs', 'liblinear']
    },
    "RandomForestClassifier": {
        'n_estimators': [50, 100, 200],
        'max_depth': [None, 10, 20]
    },
    "SVC": {
        'kernel': ['linear', 'rbf'],
        'C': [0.1, 1.0, 10.0]
    }
}

# MLflow 설정
today = datetime.today().strftime('%Y-%m-%d %H:%M:%S')
mlflow.autolog()

best_acc = 0

for model_name, model in models.items():
    # GridSearchCV 설정
    grid_search = GridSearchCV(model, param_grids[model_name], cv=5)
    
    with mlflow.start_run(run_name=f'{today} - {model_name}', nested=True):
        grid_search.fit(X_train, y_train)
        pred = grid_search.predict(X_test)
        acc = accuracy_score(y_test, pred)

        # 최고 정확도 업데이트
        if acc > best_acc:
            best_acc = acc
            print(f"새로운 최고 정확도: {best_acc * 100:.2f}%")

        # 최적의 하이퍼파라미터 및 정확도 기록
        mlflow.log_param('model_name', model_name)
        mlflow.log_param('best_params', grid_search.best_params_)
        mlflow.log_metric('accuracy', acc)

        print(f'모델명 : {model_name}, 정확도 : {acc * 100:.2f}%')

        # 각 파라미터 조합에 따른 성능 출력
        results = pd.DataFrame(grid_search.cv_results_)
        for i in range(len(results)):
            print(f"파라미터 조합: {results['params'][i]}, 정확도: {results['mean_test_score'][i] * 100:.2f}%")

# 최고 정확도 출력
print(f'최고 정확도: {best_acc * 100:.2f}%')
```

<pre>
2024/09/20 09:22:36 WARNING mlflow.utils.autologging_utils: MLflow sklearn autologging is known to be compatible with 0.24.1 <= scikit-learn <= 1.5.1, but the installed version is 1.5.2. If you encounter errors during autologging, try upgrading / downgrading scikit-learn to a compatible version, or try upgrading MLflow.
2024/09/20 09:22:37 INFO mlflow.tracking.fluent: Autologging successfully enabled for sklearn.
2024/09/20 09:22:40 INFO mlflow.sklearn.utils: Logging the 5 best runs, one run will be omitted.
2024/09/20 09:22:40 INFO mlflow.tracking._tracking_service.client: 🏃 View run 2024-09-20 09:22:36 - LogisticRegression at: http://127.0.0.1:5000/#/experiments/331369378510877407/runs/7eaa40d25cf84925b029eae4a64b6235.
2024/09/20 09:22:40 INFO mlflow.tracking._tracking_service.client: 🧪 View experiment at: http://127.0.0.1:5000/#/experiments/331369378510877407.
</pre>
<pre>
새로운 최고 정확도: 96.67%
모델명 : LogisticRegression, 정확도 : 96.67%
파라미터 조합: {'C': 0.1, 'solver': 'lbfgs'}, 정확도: 90.83%
파라미터 조합: {'C': 0.1, 'solver': 'liblinear'}, 정확도: 80.83%
파라미터 조합: {'C': 1.0, 'solver': 'lbfgs'}, 정확도: 95.83%
파라미터 조합: {'C': 1.0, 'solver': 'liblinear'}, 정확도: 90.00%
파라미터 조합: {'C': 10.0, 'solver': 'lbfgs'}, 정확도: 96.67%
파라미터 조합: {'C': 10.0, 'solver': 'liblinear'}, 정확도: 94.17%
</pre>
<pre>
2024/09/20 09:22:47 INFO mlflow.sklearn.utils: Logging the 5 best runs, 4 runs will be omitted.
2024/09/20 09:22:47 INFO mlflow.tracking._tracking_service.client: 🏃 View run 2024-09-20 09:22:36 - RandomForestClassifier at: http://127.0.0.1:5000/#/experiments/331369378510877407/runs/62b892f383b84c41ac064e6a31cf8323.
2024/09/20 09:22:47 INFO mlflow.tracking._tracking_service.client: 🧪 View experiment at: http://127.0.0.1:5000/#/experiments/331369378510877407.
</pre>
<pre>
모델명 : RandomForestClassifier, 정확도 : 93.33%
파라미터 조합: {'max_depth': None, 'n_estimators': 50}, 정확도: 92.50%
파라미터 조합: {'max_depth': None, 'n_estimators': 100}, 정확도: 92.50%
파라미터 조합: {'max_depth': None, 'n_estimators': 200}, 정확도: 92.50%
파라미터 조합: {'max_depth': 10, 'n_estimators': 50}, 정확도: 92.50%
파라미터 조합: {'max_depth': 10, 'n_estimators': 100}, 정확도: 92.50%
파라미터 조합: {'max_depth': 10, 'n_estimators': 200}, 정확도: 92.50%
파라미터 조합: {'max_depth': 20, 'n_estimators': 50}, 정확도: 92.50%
파라미터 조합: {'max_depth': 20, 'n_estimators': 100}, 정확도: 92.50%
파라미터 조합: {'max_depth': 20, 'n_estimators': 200}, 정확도: 92.50%
</pre>
<pre>
2024/09/20 09:22:50 INFO mlflow.sklearn.utils: Logging the 5 best runs, one run will be omitted.
2024/09/20 09:22:50 INFO mlflow.tracking._tracking_service.client: 🏃 View run 2024-09-20 09:22:36 - SVC at: http://127.0.0.1:5000/#/experiments/331369378510877407/runs/b1ab4a8cb598471ca11fcbfff25928f7.
2024/09/20 09:22:50 INFO mlflow.tracking._tracking_service.client: 🧪 View experiment at: http://127.0.0.1:5000/#/experiments/331369378510877407.
</pre>
<pre>
모델명 : SVC, 정확도 : 93.33%
파라미터 조합: {'C': 0.1, 'kernel': 'linear'}, 정확도: 96.67%
파라미터 조합: {'C': 0.1, 'kernel': 'rbf'}, 정확도: 90.00%
파라미터 조합: {'C': 1.0, 'kernel': 'linear'}, 정확도: 97.50%
파라미터 조합: {'C': 1.0, 'kernel': 'rbf'}, 정확도: 96.67%
파라미터 조합: {'C': 10.0, 'kernel': 'linear'}, 정확도: 95.83%
파라미터 조합: {'C': 10.0, 'kernel': 'rbf'}, 정확도: 94.17%
최고 정확도: 96.67%
</pre>

```python
# (1) 모델 등록
# http://127.0.0.1:5000/#/experiments/331369378510877407/runs/347572c94a9b4ea585116e712c5d9445
# 실험 ID : 331369378510877407
# 실행 ID : 347572c94a9b4ea585116e712c5d9445

run_id = '347572c94a9b4ea585116e712c5d9445'
model_name = 'RandomForestClassifier'

model_version = model_register(model_name, run_id)
model_version
```

<pre>
Successfully registered model 'RandomForestClassifier'.
2024/09/20 05:42:26 INFO mlflow.store.model_registry.abstract_store: Waiting up to 300 seconds for model version to finish creation. Model name: RandomForestClassifier, version 1
Created version '1' of model 'RandomForestClassifier'.
</pre>
<pre>
<ModelVersion: aliases=[], creation_timestamp=1726810946845, current_stage='None', description='', last_updated_timestamp=1726810946845, name='RandomForestClassifier', run_id='347572c94a9b4ea585116e712c5d9445', run_link='', source='mlflow-artifacts:/331369378510877407/347572c94a9b4ea585116e712c5d9445/artifacts/model', status='READY', status_message='', tags={}, user_id='', version='1'>
</pre>

```python
promote_to_staging(model_name, run_id)
```

<pre>
Registered model 'RandomForestClassifier' already exists. Creating a new version of this model...
2024/09/20 06:22:49 INFO mlflow.store.model_registry.abstract_store: Waiting up to 300 seconds for model version to finish creation. Model name: RandomForestClassifier, version 3
</pre>
<pre>
Model : RandomForestClassifier, Version : <ModelVersion: aliases=[], creation_timestamp=1726813369592, current_stage='None', description='', last_updated_timestamp=1726813369592, name='RandomForestClassifier', run_id='347572c94a9b4ea585116e712c5d9445', run_link='', source='mlflow-artifacts:/331369378510877407/347572c94a9b4ea585116e712c5d9445/artifacts/model', status='READY', status_message='', tags={}, user_id='', version='3'> promoted to Staging...
</pre>
<pre>
Created version '3' of model 'RandomForestClassifier'.
</pre>

```python
promote_to_production(model_name, '2')
archive_model(model_name, '1')
```

<pre>
Model : RandomForestClassifier, Version :2 promoted to Production...
Model : RandomForestClassifier, Version :1 Archived...
</pre>
# 모델 서빙 (Model Serving)

- Flask, FastAPI 형태로 REST API로 언제 만드냐...?

- MLFlow의 Model Serving 기능을 활용

- inference : input data를 주고 해당 값에 대한 예측을 return (API)



```python
# (1) Model Load & Inference

model_name = 'RandomForestClassifier'
model_version = '3'

model_uri = f'models:/{model_name}/{model_version}'

loaed_model = mlflow.pyfunc.load_model(model_uri)


test_input = X_test[:10]

loaed_model.predict(test_input)
```

<pre>
array([1, 2, 2, 1, 0, 1, 1, 0, 0, 1])
</pre>

```python
# (2) Model을 요청했을 때 그에 대한 응답값으로 API를 내려주는 방법
# - Flask가 함께 설치 되었다 -> API (Flask) -> 서버를 하나 더 운영을 해주어야함

mlflow models serve -m ./mlartifacts/331369378510877407/0cc9d6a81c6749638403215e22971289/artifacts/model -p 5001 --no conda

```


```python
import requests
import json

url = 'http://127.0.0.1:5001/invocations'
headers = {"Contest-Type":"application/json"}

a = {'datafrmae_split' : }
```
